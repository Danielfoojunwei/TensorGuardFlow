# Deep Dive: Privacy-Preserving Mechanics

> [!NOTE]
> This document details the advanced privacy mechanisms (OFT, FL) and security architectures (TGSP, TPSL) underpinning TensorGuard v2.0.

## 1. Federated Learning (FL) vs. Orthogonal Finetuning (OFT)

TensorGuard employs a hybrid learning strategy to balance fleet-wide knowledge acquisition with local adaptation efficiency.

### Federated Learning (FL)
**Federated Learning** is the privacy-preserving backbone for training shared global models. Instead of sending raw data to the clound, agents compute gradient updates locally.
*   **Mechanism**: Secure Aggregation (FedAvg).
*   **Privacy Guarantee**: Raw data never leaves the device.
*   **Use Case**: General knowledge acquisition across the fleet (e.g., teaching a robot arm to grasp generic objects).

![Federated Learning Architecture](../artifacts/fl_architecture.png)

### Orthogonal Finetuning (OFT)
**Orthogonal Finetuning** is a specialized Parameter-Efficient Fine-Tuning (PEFT) method used for stable, on-device adaptation. Unlike full fine-tuning which can be unstable or computationally expensive, OFT adapts the model by multiplying frozen pre-trained weights ($W_0$) with an orthogonal matrix ($R$).

*   **Equation**: $W' = W_0 \cdot R$
*   **Why Orthogonal?**: Orthogonal transformations preserve the hyperspherical energy of the weight matrix. This prevents "catastrophic forgetting" and ensures the adapted model remains stable on the edge device.
*   **Privacy Benefit**: Only the small matrix $R$ needs to be stored or transmitted (if sharing adaptation), minimizing the attack surface.

![OFT Mechanism](../artifacts/oft_mechanism.png)

---

## 2. TGSP: TensorGuard Security Profiles

**TGSP (`.tgsp`)** is the cryptographically secure envelope format used to distribute models and policies. It ensures that **what runs on the edge** is exactly **what was approved by compliance**.

### File Structure
A TGSP package is a ZIP container with a strictly defined layout:

```text
package.tgsp
├── manifest.json        # Integrity hashes & Metadata (Signed)
├── manifest.sig         # Ed25519 Signature of manifest.json
├── policy.rego          # Policy-as-Code (Cleartext)
├── weights.enc          # Model Weights (ChaCha20Poly1305 Encrypted)
└── config.json          # Runtime configuration
```

### Security Properties
1.  **Manifest Integrity**: The `manifest.json` contains SHA-256 hashes of all other files.
2.  **Non-Repudiation**: The `manifest.sig` is an Ed25519 signature generated by the Platform's Private CA key. The Agent refuses to load any package without a valid signature from a trusted root.
3.  **Confidentiality**: The implementation uses **AEAD (Authenticated Encryption with Associated Data)** via `ChaCha20Poly1305`. The Associated Data (AD) binds the encryption to the Manifest ID, preventing "mix-and-match" attacks where valid encrypted weights are swapped into a different package.

---

## 3. TPSL: TensorGuard Privacy & Security Layer

**TPSL** refers to the comprehensive defense-in-depth stack that wraps the AI runtime. It is not just one feature, but the architectural layer that sits between the OS and the AI Model.

### Core Components
1.  **Network Defense (WTFPAD)**
    *   **Website Fingerprinting Defense**: Implements adaptive padding to traffic patterns. Even if an attacker observes encrypted packet sizes and timing (side-channel analysis), they cannot infer which model architecture is being streamed or what data is being processed.
    
2.  **Identity Authority (mTLS)**
    *   **SPIFFE-compatible Identity**: Every workload gets a short-lived X.509 certificate.
    *   **Automatic Rotation**: Keys are rotated every hour (configurable), limiting the blast radius of any potential compromise.

3.  **Audit Ledger (Tamper-Proof)**
    *   **Hash Chaining**: Each audit log entry includes the SHA-256 hash of the *previous* entry. $Hash_N = SHA256(Data_N || Hash_{N-1})$.
    *   **Immutability**: This creates a blockchain-like structure where deleting or modifying an old log breaks the entire chain, making tampering immediately detectable.

### Privacy Budgeting (Differential Privacy)
*   **Epsilon ($\epsilon$) Banking**: TPSL tracks privacy consumption. Every query or inference subtracts from a global $\epsilon$ budget. When the budget is exhausted, the Agent strictly engages a "kill switch" for that data source, guaranteeing mathematical privacy bounds are never exceeded.
